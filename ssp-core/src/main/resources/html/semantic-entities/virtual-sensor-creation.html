<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />
    <title>Virtual Sensor Creation</title>
    <link href="../../style/css/semantic.css" rel="stylesheet" type="text/css" />
    <link href="../../style/css/semantic.min.css" rel="stylesheet" type="text/css"/>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Open+Sans:300italic,400,300,700'
          rel='stylesheet' type='text/css'>

    <style type="text/css">
        :not(i){
            font-family: 'Open Sans', sans-serif;
        }

        *{
            font-size: 13px;
        }

        .label{
            font-weight: bold !important;

        }

        .monospace{
            font-family: monospace;
        }
    </style>

    <script src="../../style/javascript/jquery-1.11.1.min.js"></script>
    <script src="../../style/javascript/semantic.min.js"></script>
    <script src="../../style/javascript/semantic.js"></script>
</head>

<body>
<div class="ui one column page grid">
    <div class="column">
        <div id="header">
        </div>
        <script src="../../style/javascript/ssp-menu.js"></script>

        <h4 class="ui top attached header">
            Create Single Virtual Sensor
        </h4>

        <div class="ui form segment attached">
            <div class="ui three steps" style="margin-top: 5px; margin-bottom: 20px">
                <div class="ui active step" id="step1">
                    1st step: Virtual Sensor Description
                </div>
                <div class="ui step" id="step2">
                    2nd step: Query for Sensor Value
                </div>
                <div class="ui step" id="step3">
                    3rd step: Test and Creation
                </div>
            </div>

            <div class="ui ignore blue message">
                <i class="icon info"></i>
                According to the <a href="http://www.w3.org/2005/Incubator/ssn/ssnx/ssn#Sensor">SSN Ontology</a>
                virtual sensors are computational methods that have sensing capability, i.e. observe some
                phenomenon. Step 1 is to define the phenomenon to be observed. Step 2 is to define the SPARQL query
                that returns the sensor value. Step 3 is to test and create the defined sensor.
            </div>

            <div id="step1Content">

                <div class="ui secondary segment">
                    <div class="ui small grey top left attached label">Sensor Name (POSTFIX):</div>
                    <div style="font-weight: bold">PREFIX:
                        <div class="monospace" style="font-weight: normal; display: inline">
                            http://example.org/virtual-sensors#
                        </div>
                    </div>
                    <input class="monospace triplesPart" style="margin-top: 5px" type="text"
                            value="TrafficDensitySensor-80735580-1-1" id="fldSensorName">
                </div>

                <div class="ui secondary segment">
                    <div class="ui small grey top left attached label">Type</div>
                    <p>
                        The given type URI will automatically be made a subclass of VirtualSensor which is a
                        subclass of <a href="http://www.w3.org/2005/Incubator/ssn/ssnx/ssn#Sensor">ssn:Sensor</a>.
                    </p>
                    <div style="font-weight: bold">PREFIX:
                        <div class="monospace" style="font-weight: normal; display: inline">
                            http://example.org/virtual-sensors#
                        </div>
                    </div>
                    <input class="monospace triplesPart" style="margin-top: 5px" type="text" value="VirtualTrafficDensitySensor"
                           id="fldTypeName">
                </div>

                <div class="ui secondary segment">
                    <div class="ui small grey top left attached label">Feature of Interest</div>
                    <p>
                        According to the
                        <a href="http://www.w3.org/2005/Incubator/ssn/ssnx/ssn#FeatureOfInterest">SSN Ontology</a>
                        a feature is an abstraction of real world phenomena (thing, person, event, etc).
                    </p>
                    <input class="monospace triplesPart" type="text"
                            value="http://example.org/osm#WaySectionLane-151585372-1-1" id="fldFeatureOfInterest">
                </div>

                <!--<div class="ui secondary segment">-->
                    <!--<div class="ui small grey top left attached label">Observed Property</div>-->
                    <!--<p>-->
                        <!--According to the-->
                        <!--<a href="http://www.w3.org/2005/Incubator/ssn/ssnx/ssn#observedProperty">SSN Ontology</a>-->
                        <!--an observed property is a relation linking an Observation to the Property that was observed.-->
                        <!--The observedProperty should be a Property (hasProperty) of the FeatureOfInterest-->
                        <!--(linked by featureOfInterest) of this observation.-->
                    <!--</p>-->
                    <!--<input class="monospace triplesPart" type="text" value="http://example.org/property1"-->
                           <!--id="fldObservedProperty">-->
                <!--</div>-->
            </div>

            <div id="step2Content" style="display: none">
                <div class="ui secondary segment">
                    <div class="ui small grey top left attached label">Complete SPAQRL Query (incl. Prefixes)</div>
                    <textarea class="sparqlPart monospace" id="fldQuery" style="height: 500px; min-height: 70px">
PREFIX veh: &lt;http://example.org/vehicles#&gt;
PREFIX osm: &lt;http://example.org/osm#&gt;
PREFIX geo: &lt;http://www.opengis.net/ont/geosparql#&gt;
PREFIX geof: &lt;http://www.opengis.net/def/function/geosparql/&gt;

SELECT ((COUNT(?val) / (?length / 40)) AS ?aggVal) WHERE {
  ?val a veh:Vehicle .
  ?val veh:hasLocation ?loc .
  ?loc geo:asWKT ?point .
  osm:WaySectionLane-80735580-1-1 osm:boundary ?bound .
  osm:WaySectionLane-80735580-1-1 osm:hasLengthInMeter ?length .
  ?bound geo:asWKT ?polygon
  FILTER (geof:sfWithin(?point, ?polygon))
}
GROUP BY ?length</textarea>
                </div>
            </div>

            <div id="step3Content" style="display: none">

                <div class="ui buttons" id="buttons">
                    <div class="ui blue button" id="btnTest">Test Creation</div>
                    <div class="or"></div>
                    <div class="ui green button" id="btnCreate">Create</div>
                </div>

                <!--Results-->
                <div class="ui secondary segment" id="resultSegment" style="display: none">
                    <div class="ui top left attached label" id="resultLabel">
                    </div>
                    <div id="resultContent">
                    </div>
                </div>

                <!--<div class="ui secondary segment" id="vsTestResult" style="display: none">-->
                    <!--<div class="ui top left attached label">Test Result: Sensor Description (Turtle)</div>-->
                    <!--<textarea class="monospace" id="fldOntology" readonly="readonly">-->
                    <!--</textarea>-->
                <!--</div>-->





            </div>
        </div>
    </div>
</div>

<script>
    //Initialize dropdown
    //$('.ui.dropdown').dropdown();

//    $(document).ready(function(){
//        //$('#selAggregate').val('COUNT');
//        //setSparql();
//        //setTriples();
//    });

    $('#buttons').find('div.button').click(function(event){
        event.preventDefault();

        var formData = new FormData();
        formData.append('sensorName', $('#fldSensorName').val());
        formData.append('sensorType', $('#fldTypeName').val());
        formData.append('foi', $('#fldFeatureOfInterest').val());
        formData.append('query', $('#fldQuery').val());

        //formData.append('ontology', $('#fldOntology').val());

        var btnID = $(this).attr('id');
        formData.append('button', btnID);

        $.ajax({
            type: "POST",
            url: './virtual-sensor-creation',
            data: formData,
            contentType: false,
            processData: false,
            success: function(e){
                console.log(e);
                console.log(btnID);
                $('#resultSegment').show().addClass('green');
                if(btnID == 'btnTest'){
                    $('#resultLabel').html('RDF representation of virtual sensor (Turtle-Preview)');
                    $('#resultContent').html(
                        '<p> Query Execution Duration: ' +  e['duration'] + ' ms.</p>\n' +
                        '<textarea class="monospace" style="height: 700px" readonly="readonly">\n' +
                         (e['sensorStatus']) + '\n</textarea>').show();
                }
                else{
                    $('#resultLabel').html('Virtual sensor Creation Result');
                    $('#resultContent').html(
                        '<p>Virtual Sensor succesfully created!</p>' +
                        '<p>See <a href="/?graph=' + encodeURIComponent(e['graphName']) + '">/?graph=' + e['graphName'] + '</a></p>'
                    );
                }
            },
            error: function(e){
                console.log(e);
                $('#resultSegment').show().addClass('red');
                $('#resultLabel').html('Error');
                $('#resultContent').html('<p>' + (e['responseText']) + '</p>');
            }
        });
    });

    $('.steps').find('div.step').click(function(){
        $('.steps').find('div.step').each(function(){
            $(this).removeClass('active');
        });

        $(this).addClass('active');

        if($(this).attr('id') == 'step1'){
            $('#step1Content').show();
            $('#step2Content').hide();
            $('#step3Content').hide();
        }

        else if($(this).attr('id') == 'step2'){
            $('#step1Content').hide();
            $('#step2Content').show();
            $('#step3Content').hide();
        }

        else if($(this).attr('id') == 'step3'){
            $('#step1Content').hide();
            $('#step2Content').hide();
            $('#step3Content').show();
        }
    });
</script>
</body>
</html>